# Архитектура ANMP (Версия 1.2)

## Обзор

ANMP (Advanced Network Mapping Platform) — это графическое приложение для построения и анализа карт сетей на уровнях L1, L2 и L3. Приложение построено на базе фреймворка PyQt6 и использует модульную, событийно-ориентированную архитектуру для обеспечения гибкости и расширяемости.

## Архитектурные принципы

- **Централизованное управление состоянием:** `AppStateManager` является единственным источником правды о состоянии проекта (сохранен, изменен, путь к файлу).
- **Разделение ответственности (SoC):** Каждый компонент имеет четко определенную зону ответственности (UI, управление файлами, редактирование узлов и т.д.).
- **Событийно-ориентированная архитектура (EDA):** Компоненты взаимодействуют друг с другом через сигналы и слоты Qt, что минимизирует прямые зависимости и обеспечивает слабую связанность.
- **Модель-Вид-Контроллер (MVC):** Архитектура частично следует паттерну MVC, где:
  - **Модель:** Данные проекта (словари Python), управляемые `DataManager`.
  - **Вид:** `NetworkCanvas`, `NodeEditor`, `ConnectionEditor` и другие виджеты.
  - **Контроллер:** `ANMPApp` (главный контроллер), `FileController`, `MenuController`.

## Структура и компоненты

```
ANMP/
├── main.py                # Главный класс ANMPApp (оркестратор)
├── app_state.py           # Управляет состоянием проекта
├── file_controller.py     # Управляет файловыми операциями
├── menu_controller.py     # Создает меню и панель инструментов
├── network_canvas.py      # Холст для топологии (L1, L2, или L3)
├── node_editor.py         # UI для редактирования узлов
├── connection_editor.py   # UI для редактирования соединений
├── network_scanner.py     # Логика сканирования сети
├── data_manager.py        # Сохранение/загрузка/валидация данных
├── icon_manager.py        # Управление иконками
└── utils.py               # Вспомогательные функции
```

### Основные компоненты

1.  **`ANMPApp` (`main.py`)**
    - **Роль:** Центральный оркестратор приложения.
    - **Ответственность:**
        - Инициализирует все основные компоненты.
        - Создает главный интерфейс, включая три холста (`NetworkCanvas`) для L1/L2/L3.
        - Соединяет сигналы и слоты между всеми компонентами.
        - Обрабатывает действия пользователя (например, нажатие кнопки "Соединить"), получая данные от активного холста.

2.  **`AppStateManager` (`app_state.py`)**
    - **Роль:** Хранилище состояния.
    - **Ответственность:**
        - Отслеживает, есть ли несохраненные изменения (`has_unsaved_changes`).
        - Хранит путь к текущему файлу проекта и сами данные проекта (`project_data`).
        - Генерирует сигналы (`project_loaded`, `project_modified`, `project_cleared`) при изменении состояния, на которые подписывается `ANMPApp`.

3.  **`FileController` (`file_controller.py`)**
    - **Роль:** Обработчик файловых операций.
    - **Ответственность:**
        - Отображает диалоги открытия/сохранения файла.
        - Взаимодействует с `DataManager` для чтения/записи данных.
        - Сообщает `AppStateManager` об успешной загрузке или сохранении проекта.
        - Не имеет прямого доступа к UI (кроме `QFileDialog`).

4.  **`NetworkCanvas` (`network_canvas.py`)**
    - **Роль:** Визуальное представление топологии.
    - **Ответственность:**
        - Отображает узлы (`NetworkNode`) и соединения (`NetworkConnection`).
        - Обрабатывает взаимодействие с пользователем (перемещение, выделение).
        - Генерирует сигналы `node_selected` и `connection_selected`.
        - Имеет метод `load_data` для загрузки узлов и соединений, специфичных для своего уровня.

5.  **`NodeEditor` и `ConnectionEditor`**
    - **Роль:** Панели редактирования.
    - **Ответственность:**
        - Отображают свойства выбранного элемента (узла или соединения).
        - Генерируют сигнал `*_updated` при нажатии кнопки "Применить".
        - Получают данные через слоты `set_node`/`set_connection`.

## Потоки данных

### 1. Загрузка проекта

`Пользователь нажимает "Открыть"` -> `MenuController` -> `ANMPApp` -> `FileController.open_project()`
1.  `FileController` показывает `QFileDialog`.
2.  Пользователь выбирает файл.
3.  `FileController` вызывает `DataManager.load_project()` для чтения и валидации данных.
4.  `FileController` вызывает `AppStateManager.load_project(file_path, data)`.
5.  `AppStateManager` сохраняет данные и генерирует сигнал `project_loaded(file_path)`.
6.  `ANMPApp` ловит сигнал `project_loaded`.
7.  `ANMPApp` вызывает `app_state.get_project_data()` для получения данных.
8.  `ANMPApp` распределяет узлы и соответствующие соединения по трем холстам (`l1_canvas.load_data(...)`, `l2_canvas.load_data(...)` и т.д.).

### 2. Редактирование узла

`Пользователь кликает на узел` -> `NetworkCanvas`
1.  `NetworkCanvas` генерирует сигнал `node_selected(node_data)`.
2.  `ANMPApp` ловит сигнал и вызывает `NodeEditor.set_node(node_data)`.
3.  `NodeEditor` отображает свойства узла.
4.  Пользователь меняет данные и нажимает "Применить".
5.  `NodeEditor` генерирует сигнал `node_updated(updated_data)`.
6.  `ANMPApp` ловит сигнал и вызывает `canvas.update_node(updated_data)` для **каждого** холста, чтобы обновить узел везде.

### 3. Создание соединения

`Пользователь выбирает 2 узла и нажимает "Соединить"` -> `MenuController` -> `ANMPApp.add_connection_action()`
1.  `ANMPApp` вызывает `get_active_canvas()` для получения текущего холста.
2.  `ANMPApp` вызывает `canvas.get_selected_nodes()`.
3.  Если выбрано 2 узла, `ANMPApp` вызывает `canvas.add_connection(id1, id2)`.
4.  `NetworkCanvas` создает новый объект `NetworkConnection` и добавляет его на сцену.

## Заключение

Текущая архитектура обеспечивает четкое разделение ответственности и минимизирует связанность компонентов, что упрощает дальнейшую разработку, тестирование и поддержку проекта.